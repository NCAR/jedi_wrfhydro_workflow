window begin: &date '2021-03-01T00:00:00Z'
window length: PT24H

geometry:
  input_file: ${PWD}/site_09253000/Domain/geometry_nwm_long_range.nc

background:
  members:
    - date: 2021-03-01T00:00:00Z
      read_from_file: 1
      filename_lsm: RESTART.2021030100_DOMAIN1_mem001
      filename_hydro: HYDRO_RST.2021-03-01_00:00_DOMAIN1
      state variables: ['SNEQV']
    - date: 2021-03-01T00:00:00Z
      read_from_file: 1
      filename_lsm: ./RESTART.2021030100_DOMAIN1_mem002
      filename_hydro: ./HYDRO_RST.2021-03-01_00:00_DOMAIN1
      state variables: ['SNEQV']

observations:
  observers:
  - obs space:
      name: 'Simulate'
      distribution:
        name: InefficientDistribution
      simulated variables: ['snow_water_equivalent']
      obsdatain:
        obsfile: 'site_09253000/SNOTEL_obs/owp_swe_2021-03-01T00:00:00Z.nc'
      obsdataout:
        obsfile: 'jedi_letkf_out_obs_swe_2021-03-01T00:00:00Z.nc'
    obs operator:
        name: 'Identity'
    obs error:
        covariance model: 'diagonal'
    obs localizations:
    - localization method: Horizontal SOAR
      lengthscale: 250e3
      soar horizontal decay: 2.1e-02
      max nobs: 50
    - localization method: Vertical Brasnett
      vertical lengthscale: 500
    obs filters:
    - filter: Bounds Check # negative / missing snow
      filter variables:
      - name: snow_water_equivalent
      minvalue: 0
    - filter: Bounds Check # negative / missing snow
      filter variables:
      - name: snow_water_equivalent
      maxvalue: 999999.0
    # - filter: Background Check # gross error check
    #   filter variables:
    #   - name: snow_depth
    #   threshold: 12.0
    #   action:
    #     name: reject
    - filter: Domain Check
      where:
      - variable:
          name: latitude@MetaData
        minvalue: 40.5
        maxvalue: 41.5
    - filter: Domain Check
      where:
      - variable:
          name: longitude@MetaData
        minvalue: -107.5
        maxvalue: -106.5


driver:
  save posterior mean: true
  save posterior ensemble: false
  save posterior mean increment: true

local ensemble DA:
  solver: LETKF
  inflation:
    rtps: 0.0
    rtpp: 0.0
    mult: 1.0

output:
  datadir: '.'
  date: *date
  exp: letkf
  type: 'ens'

output increment:
  datadir: '.'
  date: *date
  exp: letkf_inc
  type: 'ens'
